<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TowerDefense - Neon Zombie V5.6 (Full Exponential)</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // NOTA: firebaseConfig contiene una clave API no operativa.
        const firebaseConfig = {
            apiKey: "AIzaSyDPCHIEH-oG60kLBnOf98Qwtj56DFLcPaE",
            authDomain: "towerdefense-dfbfb.firebaseapp.com",
            projectId: "towerdefense-dfbfb",
            storageBucket: "towerdefense-dfbfb.firebasestorage.app",
            messagingSenderId: "780250375670",
            appId: "1:780250375670:web:ccded917e7b2316e5013d7",
            measurementId: "G-4GW89G9D55"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.AuthManager = {
            user: null,
            login: async (username, password) => {
                const email = `${username}@email.com`;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log(`Bienvenido de nuevo, ${username}!`);
                    Game.closeModal('auth-modal');
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        Game.showAuthError("Usuario no encontrado o contrase√±a incorrecta.");
                    } else {
                        Game.showAuthError("Error de autenticaci√≥n: " + error.message);
                    }
                }
            },
            register: async (username, password) => {
                const email = `${username}@email.com`;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    console.log(`Usuario ${username} registrado con √©xito!`);
                    Game.closeModal('auth-modal');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        Game.showAuthError("Ese nombre de usuario ya est√° registrado.");
                    } else if (error.code === 'auth/weak-password') {
                        Game.showAuthError("Contrase√±a d√©bil (m√≠nimo 6 caracteres).");
                    } else {
                        Game.showAuthError("Error de registro: " + error.message);
                    }
                }
            },
            logout: async () => {
                await signOut(auth);
                console.log("Sesi√≥n cerrada.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.AuthManager.user = user;
            const menuAuthContainer = document.getElementById('menu-auth-container');
            const logoutContainer = document.getElementById('logout-container');
            const lbl = document.getElementById('user-display');

            if (user) {
                const username = user.email.split('@')[0];
                lbl.innerText = `JUGADOR: ${username.toUpperCase()}`;
                lbl.style.display = 'block';
                menuAuthContainer.style.display = 'none';
                logoutContainer.style.display = 'block';
            } else {
                lbl.style.display = 'none';
                menuAuthContainer.style.display = 'flex';
                logoutContainer.style.display = 'none';
            }
        });

        window.ScoreManager = {
            saveScore: async (wave, difficulty, verifiedData) => {
                if (!window.AuthManager.user) return;

                const username = window.AuthManager.user.email.split('@')[0];
                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                    await addDoc(scoresRef, {
                        username: username,
                        wave: wave,
                        difficulty: difficulty,
                        timestamp: Date.now(),
                        verified: true
                    });
                    document.getElementById('save-msg').innerText = "PUNTUACI√ìN GUARDADA CON √âXITO";
                } catch (e) {
                    console.error("Error guardando score:", e);
                    document.getElementById('save-msg').innerText = "ERROR AL GUARDAR";
                }
            },
            getScores: async (difficultyVal) => {
                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                    const snapshot = await getDocs(scoresRef);
                    let scores = [];
                    snapshot.forEach(doc => scores.push(doc.data()));
                    const filtered = scores.filter(s => Math.abs(s.difficulty - difficultyVal) < 0.001);
                    filtered.sort((a, b) => b.wave - a.wave);
                    return filtered.slice(0, 10);
                } catch (e) {
                    console.error("Error cargando leaderboard:", e);
                    return [];
                }
            }
        };
    </script>
    <style>
        :root {
            --bg-dark: #0a0a12;
            --panel-bg: rgba(20, 20, 35, 0.95);
            --accent: #00ffcc;
            --accent-glow: rgba(0, 255, 204, 0.5);
            --gold: #ffcc00;
            --danger: #ff2a6d;
            --text-main: #e0e6ed;
            --border-color: #2a2a40;
            --login-color: #ffb74d;
            --register-color: #81c784;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 100%);
        }

        #game-wrapper {
            display: flex;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), 0 0 20px rgba(0, 255, 204, 0.1);
            border: 1px solid var(--border-color);
            background: #111;
            width: 1200px;
            max-width: 100%;
            height: 720px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
        }

        .auth-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            pointer-events: none;
            z-index: 2005;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 20px;
        }

        .auth-bar>* {
            pointer-events: auto;
        }

        #user-display {
            color: var(--text-main);
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .btn-auth {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Rajdhani';
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-auth:hover {
            background: var(--accent);
            color: #000;
        }

        .sidebar {
            width: 300px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            padding: 15px;
            padding-top: 60px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 10;
        }

        .sidebar.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #left-panel {
            border-left: none;
        }

        #right-panel {
            border-right: none;
        }

        #canvas-container {
            position: relative;
            flex: 1;
            background: #050505;
            cursor: crosshair;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        h1 {
            color: var(--accent);
            text-align: center;
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--accent-glow);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-val {
            font-size: 1.4rem;
            font-weight: 700;
            display: block;
            color: white;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        .stat-lbl {
            font-size: 0.8rem;
            color: #8899ac;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #upgrade-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--accent);
            padding: 15px;
            border-radius: 8px;
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .upg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .upg-level {
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: bold;
        }

        .upg-name {
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
        }

        .upg-stats {
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .btn {
            background: linear-gradient(180deg, #333, #222);
            color: #eee;
            border: 1px solid #555;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .btn:hover:not(:disabled) {
            filter: brightness(1.3);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-upg {
            background: linear-gradient(180deg, #1b5e20, #0d3311);
            border-color: #2e7d32;
            color: #81c784;
        }

        .btn-ult {
            background: linear-gradient(180deg, #4a148c, #260a46);
            border-color: #7b1fa2;
            color: #e1bee7;
            box-shadow: 0 0 10px rgba(123, 31, 162, 0.4);
        }

        .btn-sell {
            background: linear-gradient(180deg, #b71c1c, #680f0f);
            border-color: #ef5350;
            margin-top: 5px;
        }

        .btn-start {
            background: linear-gradient(180deg, #01579b, #002f55);
            border-color: #0288d1;
            width: 100%;
            color: #81d4fa;
            letter-spacing: 1px;
        }

        .btn-menu-auth {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: 2px solid #555;
            background: rgba(0, 0, 0, 0.5);
            color: #aaa;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Rajdhani', sans-serif;
            flex: 1;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .btn-menu-auth:hover {
            transform: scale(1.05);
        }

        .btn-login {
            border-color: var(--login-color);
            color: var(--login-color);
        }

        .btn-login:hover {
            background: var(--login-color);
            color: black;
            box-shadow: 0 0 20px rgba(255, 183, 77, 0.4);
        }

        .btn-register {
            border-color: var(--register-color);
            color: var(--register-color);
        }

        .btn-register:hover {
            background: var(--register-color);
            color: black;
            box-shadow: 0 0 20px rgba(129, 199, 132, 0.4);
        }

        .shop-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            padding-right: 5px;
        }

        .shop-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.2s;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .shop-icon-canvas {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            background: #111;
            border: 1px solid #444;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .shop-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .shop-name {
            font-size: 1rem;
            font-weight: bold;
            color: white;
        }

        .shop-cost {
            font-size: 0.85rem;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shop-cost::before {
            content: '‚ö°';
            font-size: 0.7rem;
        }

        #auto-start-container {
            width: 100%;
            height: 6px;
            background: #222;
            border: 1px solid #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
            display: none;
        }

        #auto-start-bar {
            height: 100%;
            background: var(--accent);
            width: 100%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--accent);
        }

        #global-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
            transition: opacity 0.5s ease, visibility 0.5s;
            opacity: 1;
            visibility: visible;
        }

        #global-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        .title-big {
            font-size: 4rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 0 0 30px var(--accent-glow), 0 0 60px var(--accent);
            margin-bottom: 10px;
            font-weight: 800;
            background: -webkit-linear-gradient(#fff, var(--accent));
            -webkit-background-clip: text;
        }

        .difficulty-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-diff {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: 2px solid #555;
            background: rgba(0, 0, 0, 0.5);
            color: #aaa;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Rajdhani', sans-serif;
        }

        .btn-diff:hover {
            transform: scale(1.05);
            color: white;
            border-color: white;
        }

        .diff-easy {
            border-color: #00e676;
            color: #00e676;
        }

        .diff-easy:hover {
            background: #00e676;
            color: black;
        }

        .diff-med {
            border-color: #ffea00;
            color: #ffea00;
        }

        .diff-med:hover {
            background: #ffea00;
            color: black;
        }

        .diff-hard {
            border-color: #ff3d00;
            color: #ff3d00;
        }

        .diff-hard:hover {
            background: #ff3d00;
            color: black;
        }

        .diff-imp {
            border-color: #d500f9;
            color: #d500f9;
            box-shadow: 0 0 10px rgba(213, 0, 249, 0.2);
        }

        .diff-imp:hover {
            background: #d500f9;
            color: black;
            box-shadow: 0 0 30px #d500f9;
        }

        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 0, 0, 0.9);
            z-index: 1500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #game-over-screen.hidden {
            display: none;
        }

        .btn-restart {
            padding: 15px 40px;
            font-size: 1.5rem;
            border: 2px solid #ff2a6d;
            color: #ff2a6d;
            background: transparent;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn-restart:hover {
            background: #ff2a6d;
            color: white;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 20px;
            z-index: 3000;
            display: none;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            flex-direction: column;
            gap: 10px;
        }

        .modal-header {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-input {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            font-family: 'Rajdhani';
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .close-modal:hover {
            color: white;
        }

        #auth-error-msg {
            color: var(--danger);
            font-size: 0.9rem;
            text-align: center;
            height: 20px;
            margin-bottom: 10px;
        }

        .lb-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .lb-table th {
            text-align: left;
            color: #888;
            font-size: 0.9rem;
            padding: 5px;
            border-bottom: 1px solid #333;
        }

        .lb-table td {
            color: white;
            padding: 8px 5px;
            font-size: 1.1rem;
            border-bottom: 1px solid #222;
        }

        .lb-table tr:nth-child(1) td {
            color: var(--gold);
        }

        .lb-rank {
            width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .lb-wave {
            text-align: right;
            color: var(--accent);
        }

        #drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 999;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px dashed white;
            display: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }

        #connection-msg {
            color: var(--accent);
            font-size: 1.2rem;
            margin-top: 20px;
            display: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div id="game-wrapper">
        <!-- BARRA SUPERIOR PARA MOSTRAR JUGADOR AUTENTICADO -->
        <div class="auth-bar">
            <div id="logout-container" style="display: none; align-items: center; gap: 10px;">
                <div id="user-display"></div>
                <button class="btn btn-auth" onclick="window.AuthManager.logout()">CERRAR SESI√ìN</button>
            </div>
        </div>

        <!-- PANTALLA DE OVERLAY GLOBAL (MEN√ö DE INICIO) -->
        <div id="global-overlay">
            <div class="title-big">NEON DEFENSE V5.6</div>

            <div id="menu-content">
                <!-- CONTENEDOR DE BOTONES DE LOGIN/REGISTER -->
                <div id="menu-auth-container" style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn-menu-auth btn-login"
                        onclick="Game.openModal('auth-modal', 'login')">ENTRAR</button>
                    <button class="btn-menu-auth btn-register"
                        onclick="Game.openModal('auth-modal', 'register')">REGISTRARSE</button>
                </div>

                <p style="color:#aaa; font-size: 1.1rem; text-align: center; margin-bottom: 10px;">SELECCIONA
                    DIFICULTAD:</p>
                <div class="difficulty-container">
                    <button class="btn-diff diff-easy" onclick="Game.start(0.05)">F√ÅCIL (+5%)</button>
                    <button class="btn-diff diff-med" onclick="Game.start(0.10)">MEDIO (+10%)</button>
                    <button class="btn-diff diff-hard" onclick="Game.start(0.15)">DIF√çCIL (+15%)</button>
                    <button class="btn-diff diff-imp" onclick="Game.start(0.20)">IMPOSIBLE (+20%)</button>
                </div>
                <button class="btn"
                    style="margin-top: 30px; width: 200px; border-color: var(--accent); color: var(--accent);"
                    onclick="Game.openLeaderboard()">VER RANKING GLOBAL</button>
            </div>
        </div>

        <!-- PANELES LATERALES -->
        <div id="left-panel" class="sidebar hidden">
            <h1>ESTADO</h1>
            <div class="stat-grid">
                <div class="stat-card"><span id="lives-display" class="stat-val"
                        style="color: var(--danger)">20</span><span class="stat-lbl">Vidas</span></div>
                <div class="stat-card"><span id="money-display" class="stat-val"
                        style="color: var(--gold)">100</span><span class="stat-lbl">Cr√©ditos</span></div>
                <div class="stat-card"><span id="wave-display" class="stat-val" style="color: #fff">1</span><span
                        class="stat-lbl">Oleada</span></div>
                <div class="stat-card"><span id="enemies-display" class="stat-val"
                        style="color: var(--accent)">0</span><span class="stat-lbl">Enemigos</span></div>
            </div>
            <div id="upgrade-panel">
                <div class="upg-header">
                    <div class="upg-name" id="upg-name">Torre</div>
                    <div class="upg-level" id="upg-level">Lv 1</div>
                </div>
                <div class="upg-stats" id="upg-desc">...</div>
                <button id="btn-upgrade" class="btn btn-upg" onclick="Game.upgradeTower()">Mejorar</button>
                <button id="btn-sell" class="btn btn-sell" onclick="Game.sellTower()">Vender</button>
                <div style="font-size:0.7rem; color:#666; text-align:center; margin-top:5px">Click fuera para cerrar
                </div>
            </div>
        </div>

        <!-- √ÅREA DE JUEGO -->
        <div id="canvas-container">
            <canvas id="gameCanvas" width="600" height="720"></canvas>
            <div id="game-over-screen" class="hidden">
                <div class="title-big" style="font-size: 3.5rem; color:#ff2a6d;">GAME OVER</div>
                <p id="score-text" style="color:white; margin-bottom:30px; font-size:1.5rem; letter-spacing: 1px;"></p>
                <div id="validation-loader" style="display:none; color:var(--accent); margin-bottom:10px;"></div>
                <div id="save-msg" style="color: var(--gold); margin-bottom: 10px; height: 20px;"></div>
                <button class="btn-restart" id="btn-restart" onclick="Game.reset()">REINICIAR</button>
            </div>
        </div>

        <!-- PANEL DERECHO -->
        <div id="right-panel" class="sidebar hidden">
            <h1>ARSENAL</h1>
            <div class="shop-grid" id="shop-container"></div>
            <div id="wave-panel">
                <div id="wave-info">Esperando inicio...</div>
                <div id="auto-start-container">
                    <div id="auto-start-bar"></div>
                </div>
                <button id="start-btn" class="btn btn-start" onclick="Game.clickStartBtn()">INICIAR OLEADA</button>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn" style="flex:1; background:#222;" onclick="Game.toggleSpeed()"
                        id="speed-btn">Velocidad: x1</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE AUTENTICACI√ìN -->
    <div id="auth-modal" class="modal">
        <span class="close-modal" onclick="Game.closeModal('auth-modal')">√ó</span>
        <div class="modal-header" id="auth-modal-header">ACCESO</div>
        <input type="text" id="auth-user" class="form-input" placeholder="Nombre de usuario">
        <input type="password" id="auth-pass" class="form-input" placeholder="Contrase√±a">
        <div id="auth-error-msg"></div>
        <button class="btn btn-start" id="btn-auth-submit" onclick="Game.submitAuth('login')">ENTRAR</button>
    </div>

    <!-- MODAL DE RANKING -->
    <div id="lb-modal" class="modal" style="width: 500px;">
        <span class="close-modal" onclick="Game.closeModal('lb-modal')">√ó</span>
        <div class="modal-header">RANKING GLOBAL</div>
        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 10px;">
            <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; border-color:#00e676"
                onclick="Game.loadLeaderboard(0.05)">F√ÅCIL</button>
            <button class="btn" style="padding: 5 px 10px; font-size: 0.8rem; border-color:#ffea00"
                onclick="Game.loadLeaderboard(0.10)">MEDIO</button>
            <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; border-color:#ff3d00"
                onclick="Game.loadLeaderboard(0.15)">DIF√çCIL</button>
            <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; border-color:#d500f9"
                onclick="Game.loadLeaderboard(0.20)">IMPOSIBLE</button>
        </div>
        <div id="lb-content" style="min-height: 200px;">Cargando...</div>
    </div>

    <div id="drag-ghost"></div>

    <script>

        const TILE = 40; const COLS = 15; const ROWS = 18;

        const ZOMBIE_MAP = {
            grid: [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]],
            points: [{ c: 0, r: 1 }, { c: 12, r: 1 }, { c: 12, r: 4 }, { c: 2, r: 4 }, { c: 2, r: 7 }, { c: 12, r: 7 }, { c: 12, r: 10 }, { c: 2, r: 10 }, { c: 2, r: 13 }, { c: 14, r: 13 }]
        };

        const PALETTE = {
            cannon: '#ff9100', bow: '#00e676', mortar: '#f50057', ice: '#00b0ff', electro: '#d500f9', laser: '#ff00cc', sniper: '#76ff03', minigun: '#2979ff', plasma: '#ff3d00',
            bio: '#76ff03', sonic: '#00e5ff', neutron: '#304ffe', titan: '#ffd700', gamma: '#00ff00', vortex: '#6200ea', omega: '#ffffff'
        };

        const BASIC_TOWERS = {

            // ===== EARLY GAME =====
            cannon: {
                name: "Blaster", symbol: "üí•", type: "cannon",
                color: PALETTE.cannon,
                cost: 60, dmg: 12, range: 3 * TILE, rate: 45,
                radius: 10,
                desc: "B√°sico s√≥lido.",
                upgrades: [
                    { cost: 40, text: "+6 Dmg", apply: t => t.dmg += 6 },
                    { cost: 60, text: "+12 Dmg", apply: t => t.dmg += 12 },
                    { cost: 80, text: "+Range", apply: t => { t.dmg += 10; t.range += TILE } },
                    { cost: 250, text: "ULT: Explosivo", apply: t => { t.isUlt = true; t.splash = 2 * TILE } }
                ]
            },

            bow: {
                name: "R√°pido", symbol: "üèπ", type: "bow",
                color: PALETTE.bow,
                cost: 110, dmg: 7, range: 4 * TILE, rate: 22,
                critChance: 0.15, critMult: 2,
                radius: 9,
                desc: "Alta cadencia.",
                upgrades: [
                    { cost: 80, text: "Speed", apply: t => t.rate *= 0.8 },
                    { cost: 100, text: "+3 Dmg", apply: t => t.dmg += 3 },
                    { cost: 150, text: "Pierce", apply: t => t.pierce = 2 },
                    { cost: 400, text: "ULT: Triple", apply: t => { t.isUlt = true; t.multiShot = 3 } }
                ]
            },

            ice: {
                name: "Cryo", symbol: "‚ùÑÔ∏è", type: "ice",
                color: PALETTE.ice,
                cost: 100, dmg: 6, range: 3 * TILE, rate: 45,
                slow: 0.5, slowDur: 140,
                radius: 10,
                desc: "Control real.",
                upgrades: [
                    { cost: 100, text: "+Dur", apply: t => t.slowDur += 120 },
                    { cost: 150, text: "+Range", apply: t => t.range += TILE },
                    { cost: 180, text: "Hard Slow", apply: t => t.slow = 0.35 },
                    { cost: 350, text: "ULT: Freeze", apply: t => { t.isUlt = true; t.freeze = true } }
                ]
            },

            // ===== MID GAME =====
            mortar: {
                name: "Artiller√≠a", symbol: "üí£", type: "mortar",
                color: PALETTE.mortar,
                cost: 190, dmg: 30, range: 5 * TILE, rate: 85,
                splash: 2.2 * TILE,
                radius: 12,
                desc: "√Årea.",
                upgrades: [
                    { cost: 120, text: "+Area", apply: t => t.splash += TILE },
                    { cost: 180, text: "+20 Dmg", apply: t => t.dmg += 20 },
                    { cost: 200, text: "Fast", apply: t => t.rate *= 0.8 },
                    { cost: 650, text: "ULT: Barrage", apply: t => { t.isUlt = true; t.dmg += 180; t.splash += 2 * TILE } }
                ]
            },

            electro: {
                name: "Tesla", symbol: "‚ö°", type: "electro",
                color: PALETTE.electro,
                cost: 200, dmg: 12, range: 3.5 * TILE, rate: 40,
                chain: 3,
                radius: 10,
                desc: "Control en masa.",
                upgrades: [
                    { cost: 150, text: "+Jump", apply: t => t.chain++ },
                    { cost: 200, text: "+10 Dmg", apply: t => t.dmg += 10 },
                    { cost: 300, text: "+2 Jumps", apply: t => t.chain += 2 },
                    { cost: 700, text: "ULT: Storm", apply: t => { t.isUlt = true; t.chain = 8; t.dmg *= 1.3 } }
                ]
            },

            laser: {
                name: "L√°ser", symbol: "üßø", type: "laser",
                color: PALETTE.laser,
                cost: 160, dmg: 4, range: 4 * TILE, rate: 4,
                radius: 9,
                desc: "DPS constante.",
                upgrades: [
                    { cost: 200, text: "+2 Dmg", apply: t => t.dmg += 2 },
                    { cost: 250, text: "+Range", apply: t => t.range += TILE },
                    { cost: 300, text: "Burn", apply: t => t.burn = true },
                    { cost: 650, text: "ULT: Disintegrate", apply: t => { t.isUlt = true; t.ignoreArmor = true; t.rate = 3 } }
                ]
            },

            sniper: {
                name: "Railgun", symbol: "üî≠", type: "sniper",
                color: PALETTE.sniper,
                cost: 480, dmg: 260, range: 9 * TILE, rate: 150,
                radius: 8,
                desc: "Anti-boss.",
                upgrades: [
                    { cost: 250, text: "+120 Dmg", apply: t => t.dmg += 120 },
                    { cost: 400, text: "Pierce", apply: t => t.pierce = 3 },
                    { cost: 500, text: "Fast", apply: t => t.rate *= 0.75 },
                    { cost: 1500, text: "ULT: Execution", apply: t => { t.isUlt = true; t.dmg += 600; t.pierce = 8 } }
                ]
            },

            // ===== DIAMANTE =====
            sonic: {
                name: "Sonic", symbol: "üîä", type: "sonic",
                color: PALETTE.sonic,
                cost: 520, dmg: 25, range: 3 * TILE, rate: 28,
                splash: 2.8 * TILE, slow: 0.35, slowDur: 45,
                radius: 12,
                desc: "Control total.",
                upgrades: [
                    { cost: 400, text: "+Range", apply: t => t.range += TILE },
                    { cost: 500, text: "+Stun", apply: t => t.slowDur += 25 },
                    { cost: 800, text: "Shockwave", apply: t => t.splash += TILE },
                    { cost: 2000, text: "ULT: Bass Drop", apply: t => { t.isUlt = true; t.dmg = 110; t.slow = 0.08 } }
                ]
            },

            plasma: {
                name: "Inferno", symbol: "‚òÄÔ∏è", type: "plasma",
                color: PALETTE.plasma,
                cost: 320, dmg: 9, range: 3.5 * TILE, rate: 5,
                splash: 1.8 * TILE,
                radius: 11,
                desc: "AoE DPS.",
                upgrades: [
                    { cost: 900, text: "+Area", apply: t => t.splash *= 1.25 },
                    { cost: 1000, text: "+4 Dmg", apply: t => t.dmg += 4 },
                    { cost: 1200, text: "Napalm", apply: t => t.burn = true },
                    { cost: 3000, text: "ULT: Supernova", apply: t => { t.isUlt = true; t.dmg *= 2.2; t.splash *= 1.5 } }
                ]
            },

            gamma: {
                name: "Gamma", symbol: "‚ò¢Ô∏è", type: "gamma",
                color: PALETTE.gamma,
                cost: 1500, dmg: 90, range: 5 * TILE, rate: 10,
                radius: 12,
                desc: "Anti-tank.",
                upgrades: [
                    { cost: 2000, text: "Irradiate", apply: t => t.burn = true },
                    { cost: 3000, text: "+100 Dmg", apply: t => t.dmg += 100 },
                    { cost: 4000, text: "Fast", apply: t => t.rate = 8 },
                    { cost: 12000, text: "ULT: Meltdown", apply: t => { t.isUlt = true; t.dmg = 420; t.rate = 6 } }
                ]
            },

            vortex: {
                name: "Vortex", symbol: "üåÄ", type: "vortex",
                color: PALETTE.vortex,
                cost: 2400, dmg: 260, range: 4 * TILE, rate: 40,
                splash: 3.5 * TILE, slow: 0.25,
                radius: 13,
                desc: "Control + da√±o.",
                upgrades: [
                    { cost: 3000, text: "Event Horizon", apply: t => t.splash = 4.5 * TILE },
                    { cost: 4000, text: "+240 Dmg", apply: t => t.dmg += 240 },
                    { cost: 5000, text: "Pull", apply: t => t.slow = 0.35 },
                    { cost: 20000, text: "ULT: Singularity", apply: t => { t.isUlt = true; t.dmg = 3000; t.splash = 5 * TILE } }
                ]
            },

            // ===== LATE GAME =====
            titan: {
                name: "Titan", symbol: "üëë", type: "titan",
                color: PALETTE.titan,
                cost: 3200, dmg: 420, range: 6 * TILE, rate: 130,
                splash: 2.3 * TILE, critChance: 0.2, critMult: 2.2,
                radius: 14,
                desc: "Mini-boss.",
                upgrades: [
                    { cost: 2500, text: "+300 Dmg", apply: t => t.dmg += 300 },
                    { cost: 4000, text: "Semi-Global", apply: t => t.range = 15 * TILE },
                    { cost: 6000, text: "Fast", apply: t => t.rate *= 0.8 },
                    { cost: 20000, text: "ULT: Doomsday", apply: t => { t.isUlt = true; t.dmg = 5000; t.splash = 5 * TILE } }
                ]
            },

            omega: {
                name: "Omega", symbol: "‚ôæÔ∏è", type: "omega",
                color: PALETTE.omega,
                cost: 5000, dmg: 3500, range: 10 * TILE, rate: 100,
                splash: 3 * TILE, ignoreArmor: true,
                radius: 18,
                desc: "Dios.",
                upgrades: [
                    { cost: 25000, text: "Reality Break", apply: t => t.dmg += 3000 },
                    { cost: 40000, text: "Omnipresent", apply: t => t.range = 30 * TILE },
                    { cost: 80000, text: "Erasure", apply: t => { t.dmg *= 3; t.splash = 5 * TILE } },
                    { cost: 150000, text: "ULT: The End", apply: t => { t.isUlt = true; t.dmg = 50000; t.rate = 15 } }
                ]
            }

        };


        let CURRENT_ARSENAL = BASIC_TOWERS;

        // ECONOMY NERF: Dinero por muerte reducido
        const ENEMY_DATA = {

            // ===== EARLY =====
            basic: {
                hp: 14,
                speed: 1.5,
                money: 5,
                color: "#e0e0e0",
                radius: 10,
                immune: false,
                glow: "rgba(255,255,255,0.4)"
            },

            fast: {
                hp: 12,
                speed: 3.2,
                money: 7,
                color: "#ffea00",
                radius: 8,
                immune: false,
                glow: "rgba(255,234,0,0.5)"
            },

            tank: {
                hp: 90,
                speed: 0.8,
                money: 25,
                color: "#ff3d00",
                radius: 14,
                immune: false,
                glow: "rgba(255,61,0,0.6)"
            },

            special: {
                hp: 30,
                speed: 1.6,
                money: 14,
                color: "#d500f9",
                radius: 11,
                immune: true,
                glow: "rgba(213,0,249,0.6)"
            },

            // ===== MID BOSSES =====
            boss: {
                hp: 450,
                speed: 0.55,
                money: 300,
                color: "#b71c1c",
                radius: 22,
                immune: false,
                glow: "rgba(183,28,28,0.8)"
            },

            white_guard: {
                hp: 2500,
                speed: 0.6,
                money: 150,
                color: "#ffffff",
                radius: 16,
                immune: false,
                white: true,
                glow: "rgba(255,255,255,0.9)"
            },

            white_boss: {
                hp: 3000,
                speed: 0.45,
                money: 1200,
                color: "#ffffff",
                radius: 25,
                immune: true,
                white: true,
                glow: "rgba(255,255,255,1)"
            },

            // ===== ADVANCED BOSSES =====
            mecha_hydra: {
                hp: 4500,
                speed: 0.4,
                money: 2500,
                color: "#00ff00",
                radius: 28,
                immune: false,
                glow: "rgba(0,255,0,0.8)"
            },

            cyber_angel: {
                hp: 4200,
                speed: 1.1,
                money: 3000,
                color: "#00ccff",
                radius: 20,
                immune: true,
                glow: "rgba(0,200,255,1)"
            },

            galactic_devourer: {
                hp: 9000,
                speed: 0.3,
                money: 4000,
                color: "#ff00ff",
                radius: 30,
                immune: true,
                glow: "rgba(255,0,255,0.85)"
            },

            void_boss: {
                hp: 14000,
                speed: 0.35,
                money: 6000,
                color: "#311b92",
                radius: 28,
                immune: true,
                glow: "rgba(100,0,255,1)"
            },

            // ===== ENDGAME BOSSES =====
            chaos_lord: {
                hp: 40000,
                speed: 0.3,
                money: 20000,
                color: "#000000",
                radius: 35,
                immune: true,
                white: true,
                glow: "rgba(255,0,0,1)"
            },

            neon_god: {
                hp: 80000,
                speed: 0.25,
                money: 60000,
                color: "#ffd700",
                radius: 32,
                immune: true,
                glow: "rgba(255,215,0,1)"
            },

            entity_zero: {
                hp: 350000,
                speed: 0.2,
                money: 1000000,
                color: "#ffffff",
                radius: 40,
                immune: true,
                white: true,
                glow: "rgba(255,255,255,1)"
            }

        };


        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            laserOsc: null, laserGain: null,
            initLaser() { if (this.laserOsc) return; this.laserOsc = this.ctx.createOscillator(); this.laserGain = this.ctx.createGain(); this.laserOsc.type = 'sawtooth'; this.laserOsc.frequency.value = 100; const f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 300; this.laserOsc.connect(f); f.connect(this.laserGain); this.laserGain.connect(this.ctx.destination); this.laserGain.gain.value = 0; this.laserOsc.start(); },
            setLaserVolume(n) { if (!this.laserGain) this.initLaser(); const t = this.ctx.currentTime; this.laserGain.gain.setTargetAtTime(Math.min(0.3, n * 0.05), t, 0.1); if (n > 0) this.laserOsc.frequency.setTargetAtTime(100 + (n * 10), t, 0.1); },
            play(type) {
                if (this.ctx.state === 'suspended') { this.ctx.resume(); this.initLaser(); }
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); const now = this.ctx.currentTime;
                if (type === 'shoot') { osc.type = 'square'; osc.frequency.setValueAtTime(400 + Math.random() * 100, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
                else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(0, now + 0.05); gain.gain.setValueAtTime(0.03, now); osc.start(now); osc.stop(now + 0.05); }
            }
        };

        class Entity { constructor(x, y) { this.x = x; this.y = y; this.dead = false; } }

        class Enemy extends Entity {
            constructor(type) {
                super(Game.waypoints[0].x, Game.waypoints[0].y);
                this.idx = 0;
                const data = ENEMY_DATA[type];

                // --- DIFFICULTY SCALING (FULL EXPONENTIAL) ---
                // Curva completamente exponencial desde el inicio.
                // Base 1.12^x asegura que se vuelve brutalmente dif√≠cil r√°pidamente.
                let waveMult = 1.5 * Math.pow(1.12, Game.wave - 1);

                this.maxHp = Math.floor(data.hp * waveMult);

                if (type === 'boss') this.maxHp = Math.floor(this.maxHp * 2.5);
                this.hp = this.maxHp;
                this.speedBase = data.speed; this.speed = this.speedBase;
                this.color = data.color; this.glow = data.glow; this.radius = data.radius;
                this.money = data.money;
                this.immune = data.immune || false; this.isWhite = data.white || false;
                this.slowTimer = 0; this.freezeTimer = 0; this.flash = 0;
                this.offsetY = (Game.random() - 0.5) * 10;
                this.offsetX = (Game.random() - 0.5) * 10;
                this.totalFrozen = 0;
            }
            update() {
                if (this.freezeTimer > 0) { this.totalFrozen++; if (this.totalFrozen >= 120) this.freezeTimer = 0; else { this.freezeTimer--; return; } }
                if (this.slowTimer > 0) { this.slowTimer--; this.speed = this.speedBase * (this.slowFactor || 0.6); } else this.speed = this.speedBase;
                const target = Game.waypoints[this.idx + 1];
                if (!target) return;
                const tx = target.x; const ty = target.y;
                const dx = tx - this.x; const dy = ty - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist < this.speed) { this.x = tx; this.y = ty; this.idx++; if (this.idx >= Game.waypoints.length - 1) Game.leakEnemy(this); }
                else { this.x += (dx / dist) * this.speed; this.y += (dy / dist) * this.speed; }
                if (this.flash > 0) this.flash--;
            }
            hit(dmg) {
                this.hp -= dmg; this.flash = 4; AudioEngine.play('hit');
                Game.addJuice('text', this.x, this.y - 15, Math.floor(dmg));
                if (this.hp <= 0) Game.killEnemy(this);
            }
            applyStatus(e, d, s) { if (this.immune) return; if (e === 'slow') { this.slowTimer = d; this.slowFactor = s; } if (e === 'freeze') { if (this.totalFrozen >= 120) return; this.freezeTimer = d; } if (e === 'burn') { if (!this.burnTimer) { this.burnTimer = d; const i = setInterval(() => { if (this.dead) clearInterval(i); if (this.burnTimer > 0) { this.hp -= 2; this.burnTimer -= 10; } else clearInterval(i); }, 200); } else { this.burnTimer = d; } } }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x + this.offsetX * 0.5, this.y + this.offsetY * 0.5);
                if (this.totalFrozen >= 120 && Game.frames % 20 < 10) { ctx.shadowBlur = 15; ctx.shadowColor = '#fff'; } else { ctx.shadowBlur = 15; ctx.shadowColor = this.glow; }
                ctx.fillStyle = this.flash > 0 ? '#fff' : (this.freezeTimer > 0 ? '#ccffff' : this.color);
                ctx.beginPath();
                if (this.immune) { ctx.moveTo(0, -this.radius); ctx.lineTo(this.radius, 0); ctx.lineTo(0, this.radius); ctx.lineTo(-this.radius, 0); }
                else if (this.radius > 15) { ctx.arc(0, 0, this.radius, 0, Math.PI * 2); } else { ctx.arc(0, 0, this.radius, 0, Math.PI * 2); }
                ctx.fill();
                if (this.isWhite) { ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke(); }
                ctx.shadowBlur = 0;
                const pct = Math.max(0, this.hp / this.maxHp);
                let hpColor = '#00e676'; if (pct < 0.5) hpColor = '#ffea00'; if (pct < 0.25) hpColor = '#ff2a6d';
                ctx.fillStyle = hpColor; ctx.font = "bold 14px 'Rajdhani', sans-serif"; ctx.textAlign = "center"; ctx.shadowColor = "black"; ctx.shadowBlur = 4;
                let displayHp = Math.ceil(this.hp);
                if (displayHp > 1000000000) displayHp = (displayHp / 1000000000).toFixed(1) + 'B';
                else if (displayHp > 1000000) displayHp = (displayHp / 1000000).toFixed(1) + 'M';
                else if (displayHp > 1000) displayHp = (displayHp / 1000).toFixed(1) + 'k';
                ctx.fillText(displayHp, 0, -this.radius - 10);
                ctx.shadowBlur = 0; ctx.restore();
            }
        }

        class Tower extends Entity {
            constructor(c, r, type) {
                if (typeof type === 'undefined') { super(c, r); this.key = arguments[2]; this.dummy = true; }
                else { super(c * TILE + TILE / 2, r * TILE + TILE / 2); this.c = c; this.r = r; this.key = type; }
                const data = CURRENT_ARSENAL[this.key];
                this.name = data.name; this.color = data.color; this.dmg = data.dmg; this.range = data.range; this.rate = data.rate; this.spent = data.cost;
                this.level = 1; this.cooldown = 0; this.angle = -Math.PI / 2; this.recoil = 0; this.pierce = 0; this.splash = data.splash || 0; this.chain = data.chain || 0;
                this.multiShot = 0; this.isUlt = false; this.critChance = data.critChance || 0; this.critMult = data.critMult || 1; this.slow = data.slow || 0; this.slowDur = data.slowDur || 0;
                this.efficiency = 1.0; this.shootScale = 1.0; this.isFiring = false; this.target = null;
                this.ignoreArmor = data.ignoreArmor || false; this.burn = data.burn || false;
            }
            upgrade() {
                const data = CURRENT_ARSENAL[this.key], upg = data.upgrades[this.level - 1];
                if (!upg) return;
                upg.apply(this); this.spent += upg.cost; this.level++;
                Game.addJuice('ring', this.x, this.y, TILE, '#fff');
                Game.recalcBlasterNerf();
            }
            update() {
                if (this.recoil > 0) this.recoil *= 0.8;
                if (this.shootScale > 1.0) { this.shootScale += (1.0 - this.shootScale) * 0.2; if (this.shootScale < 1.01) this.shootScale = 1.0; }
                if (this.cooldown > 0) this.cooldown--;
                this.target = this.findTarget();

                const isContinuousBeam = this.key === 'laser' || (this.key === 'omega' && this.isUlt);

                if (this.target) {
                    const targetAngle = Math.atan2(this.target.y - this.y, this.target.x - this.x);
                    this.angle = targetAngle;

                    if (isContinuousBeam) {
                        this.isFiring = true;
                        if (this.cooldown <= 0) {
                            let dmg = this.dmg * (this.efficiency || 1);
                            Game.damageEnemy(this.target, dmg);
                            Game.addJuice('particle', this.target.x, this.target.y, 1, this.color);
                            if (this.burn) this.target.applyStatus('burn', 60, 2);
                            this.cooldown = this.rate;
                        }
                    } else {
                        this.isFiring = false;
                        if (this.cooldown <= 0) {
                            this.shoot(this.target);
                            this.cooldown = Math.max(2, this.rate);
                            this.recoil = 6; this.shootScale = 1.4;
                        }
                    }
                } else {
                    this.isFiring = false;
                }
            }
            findTarget() {
                let best = null; let maxIdx = -1; let minDist = Infinity;
                for (let e of Game.enemies) {
                    const dist = Math.hypot(e.x - this.x, e.y - this.y);
                    if (dist <= this.range) { if (e.idx > maxIdx) { maxIdx = e.idx; minDist = dist; best = e; } else if (e.idx === maxIdx && dist < minDist) { minDist = dist; best = e; } }
                } return best;
            }
            shoot(target) {
                AudioEngine.play('shoot');
                Game.addJuice('muzzle', this.x + Math.cos(this.angle) * 20, this.y + Math.sin(this.angle) * 20, 0, this.color);
                if (this.key === 'electro') this.doChainLightning(target);
                else if (this.key === 'minigun' && this.multiShot > 0) { for (let i = 0; i < this.multiShot; i++) Game.projectiles.push(new Projectile(this, target, this.angle + (Game.random() - 0.5) * 0.2)); }
                else if (this.key === 'bow' && this.multiShot > 0) { for (let i = -1; i <= 1; i++) Game.projectiles.push(new Projectile(this, target, this.angle + i * 0.25)); }
                else Game.projectiles.push(new Projectile(this, target, this.angle));
            }
            doChainLightning(target) {
                let visited = [target], curr = target, damage = this.dmg;
                Game.damageEnemy(target, damage);
                Game.addJuice('bolt', this.x, this.y, target.x, target.y, this.color);
                let jumps = this.chain;
                for (let i = 0; i < jumps; i++) {
                    let next = null, minDist = 180;
                    for (let e of Game.enemies) { if (!visited.includes(e)) { let d = Math.hypot(e.x - curr.x, e.y - curr.y); if (d < minDist) { minDist = d; next = e; } } }
                    if (next) { visited.push(next); Game.damageEnemy(next, damage * 0.85); Game.addJuice('bolt', curr.x, curr.y, next.x, next.y, this.color); curr = next; } else break;
                }
            }
            draw(ctx) {
                const centerX = this.dummy ? 20 : 0;
                const centerY = this.dummy ? 20 : 0;

                ctx.save();
                if (!this.dummy) {
                    ctx.translate(this.x, this.y);
                } else {
                    ctx.translate(centerX, centerY);
                }

                ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#444'; ctx.lineWidth = 1; ctx.stroke();
                ctx.fillStyle = this.level >= 4 ? '#ffd700' : this.color;
                if (!this.dummy) { for (let i = 0; i < this.level; i++) { ctx.beginPath(); ctx.arc(-10 + i * 7, -18, 2, 0, Math.PI * 2); ctx.fill(); } }
                ctx.rotate(this.angle); ctx.translate(-this.recoil, 0);
                if (this.shootScale > 1.0) ctx.scale(this.shootScale, this.shootScale * 0.8);
                ctx.shadowBlur = this.isUlt ? 15 : 5; ctx.shadowColor = this.color; ctx.fillStyle = this.color;

                if (this.key === 'cannon' || this.key === 'mortar' || this.key === 'plasma' || this.key === 'neutron' || this.key === 'bio' || this.key === 'vortex') {
                    ctx.fillRect(-12, -12, 24, 24); ctx.fillStyle = '#111'; ctx.fillRect(0, -4, 24, 8); ctx.strokeStyle = this.color; ctx.strokeRect(-12, -12, 24, 24);
                }
                else if (this.key === 'bow' || this.key === 'sniper') {
                    ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(-10, 12); ctx.lineTo(-5, 0); ctx.lineTo(-10, -12); ctx.fill();
                    if (this.key === 'sniper') { ctx.fillStyle = '#111'; ctx.fillRect(0, -1, 25, 2); }
                }
                else if (this.key === 'minigun') {
                    ctx.fillRect(-10, -10, 20, 20); ctx.fillStyle = '#111'; ctx.fillRect(5, -6, 15, 3); ctx.fillRect(5, 0, 15, 3); ctx.fillRect(5, 6, 15, 3);
                    if (this.multiShot > 0) ctx.fillRect(5, -9, 15, 3);
                }
                else if (this.key === 'laser') {
                    ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(-8, 8); ctx.lineTo(-8, -8); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.fillRect(-4, -2, 8, 4);
                }
                else if (this.key === 'sonic' || this.key === 'gamma') {
                    ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI * 2); ctx.stroke();
                    ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI * 2); ctx.fill();
                }
                else if (this.key === 'omega') {
                    ctx.beginPath(); ctx.moveTo(12, 0); ctx.lineTo(0, 12); ctx.lineTo(-12, 0); ctx.lineTo(0, -12); ctx.fill();
                    ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI * 2); ctx.fill();
                }
                else {
                    ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI * 2); ctx.stroke();
                    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI * 2); ctx.fill();
                }
                ctx.restore();

                const isContinuousBeam = this.key === 'laser' || (this.key === 'omega' && this.isUlt);

                if (isContinuousBeam) {
                    if (this.isFiring && this.target && !this.target.dead && !this.dummy) {
                        const dist = Math.hypot(this.target.x - this.x, this.target.y - this.y);
                        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                        ctx.shadowBlur = 10; ctx.shadowColor = this.color; ctx.strokeStyle = this.color; ctx.lineWidth = 4 + Math.sin(Game.frames * 0.5) * 2;
                        ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(dist, 0); ctx.stroke();
                        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(dist, 0); ctx.stroke();
                        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(dist, 0, 4 + Math.random() * 3, 0, Math.PI * 2); ctx.fill(); ctx.restore();
                    }
                }
                if (!this.dummy && this.efficiency < 1.0) { ctx.fillStyle = '#ff2a6d'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(`${Math.floor(this.efficiency * 100)}%`, this.x, this.y - 20); }
            }
        }

        class Projectile extends Entity {
            constructor(tower, target, angle) {
                super(tower.x, tower.y);
                this.tower = tower; this.target = target; this.tx = target.x; this.ty = target.y;
                this.speed = 12;
                if (tower.key === 'sniper' || tower.key === 'neutron') this.speed = 30;
                this.vx = Math.cos(angle) * this.speed; this.vy = Math.sin(angle) * this.speed;
                this.trail = [];
                if (tower.key === 'mortar' || tower.key === 'titan' || tower.key === 'bio' || tower.key === 'vortex' || tower.key === 'omega') {
                    this.isArc = true; this.progress = 0; this.startX = this.x; this.startY = this.y;
                    this.speed = 0.03; if (tower.key === 'titan' && tower.isUlt) this.speed = 0.04;
                    if (tower.key === 'bio') this.speed = 0.04;
                    if (tower.key === 'vortex') this.speed = 0.02;
                    if (tower.key === 'omega') this.speed = 0.05;
                }
                if (tower.key === 'plasma') { this.speed = 15; this.vx = Math.cos(angle) * this.speed; this.vy = Math.sin(angle) * this.speed; }
                if (tower.key === 'sonic' || tower.key === 'gamma') { this.speed = 8; this.vx = Math.cos(angle) * this.speed; this.vy = Math.sin(angle) * this.speed; }
            }
            update() {
                this.trail.push({ x: this.x, y: this.y }); if (this.trail.length > 5) this.trail.shift();
                if (this.isArc) {
                    this.progress += this.speed;
                    if (this.progress >= 1) { this.hitArea(this.tx, this.ty); this.dead = true; }
                    else { this.x = this.startX + (this.tx - this.startX) * this.progress; this.y = this.startY + (this.ty - this.startY) * this.progress; this.z = -Math.sin(this.progress * Math.PI) * 120; }
                } else {
                    this.x += this.vx; this.y += this.vy;
                    if (this.x < 0 || this.x > 600 || this.y < 0 || this.y > 720) { this.dead = true; return; }
                    for (let e of Game.enemies) {
                        if (Math.hypot(e.x - this.x, e.y - this.y) < e.radius + 8) {
                            if (this.tower.splash > 0) this.hitArea(this.x, this.y); else this.hitSingle(e);
                            if (this.tower.pierce > 0) { if (!this.pierceCount) this.pierceCount = this.tower.pierce; this.pierceCount--; if (this.pierceCount <= 0) this.dead = true; } else { this.dead = true; } break;
                        }
                    }
                }
            }
            hitSingle(e) {
                let dmg = this.tower.dmg * (this.tower.efficiency || 1);
                if (this.tower.critChance > 0 && Game.random() < this.tower.critChance) { dmg *= this.tower.critMult; Game.addJuice('text', e.x, e.y - 20, 'CRIT!', '#ffea00'); }
                if (this.tower.ignoreArmor) { /* Logic handled by not reducing dmg */ }

                Game.damageEnemy(e, dmg);
                if (this.tower.key === 'ice') { if (this.tower.freeze) e.applyStatus('freeze', 60); else e.applyStatus('slow', this.tower.slowDur, this.tower.slow); }
                if (this.tower.key === 'sonic') e.applyStatus('slow', this.tower.slowDur, this.tower.slow);
                if (this.tower.burn) e.applyStatus('burn', 120, 2);
                if (this.tower.key === 'gamma') e.applyStatus('burn', 150, 4); // Gamma radiation burn

                Game.addJuice('particle', this.x, this.y, 6, this.tower.color);
            }
            hitArea(x, y) {
                Game.addJuice('explosion', x, y, this.tower.splash, this.tower.color); Game.shake = 8;
                let dmg = this.tower.dmg * (this.tower.efficiency || 1);
                for (let e of Game.enemies) {
                    if (Math.hypot(e.x - x, e.y - y) <= this.tower.splash) {
                        Game.damageEnemy(e, dmg);
                        if (this.tower.key === 'ice') { if (this.tower.freeze) e.applyStatus('freeze', 60); else e.applyStatus('slow', this.tower.slowDur, this.tower.slow); }
                        if (this.tower.key === 'sonic') e.applyStatus('slow', this.tower.slowDur, this.tower.slow);
                        if (this.tower.key === 'vortex') e.applyStatus('slow', 60, 0.3); // Vortex sucks them in (slows)
                        if (this.tower.burn) e.applyStatus('burn', 120, 2);
                    }
                }
            }
            draw(ctx) {
                if (this.trail.length > 1) { ctx.beginPath(); ctx.strokeStyle = this.tower.color; ctx.lineWidth = this.tower.key === 'sniper' ? 1 : 2; ctx.moveTo(this.trail[0].x, this.trail[0].y + (this.z || 0)); for (let p of this.trail) ctx.lineTo(p.x, p.y + (this.z || 0)); ctx.stroke(); }
                ctx.fillStyle = this.tower.color; ctx.shadowBlur = 5; ctx.shadowColor = this.tower.color; ctx.beginPath(); ctx.arc(this.x, this.y + (this.z || 0), 3, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
            }
        }

        const Game = {
            canvas: document.getElementById('gameCanvas'), ctx: document.getElementById('gameCanvas').getContext('2d'),
            money: 150, lives: 20, wave: 1, difficulty: 0.1, enemies: [], towers: [], projectiles: [], particles: [], waveQueue: [],
            spawnTimer: 0, playing: false, speed: 1, shake: 0, selectedTower: null, frames: 0, map: ZOMBIE_MAP, waypoints: [],
            autoStartTimer: 0, autoStartMax: 600, isAutoStarting: false,
            authMode: 'login',
            rngSeed: 12345,

            async init() {
                await this.checkCustomMod();
                this.renderShop();
                this.loop();
                this.canvas.addEventListener('mousedown', e => this.handleClick(e));
                this.canvas.addEventListener('mousemove', e => this.handleMove(e));
                document.addEventListener('mouseup', e => this.handleDragEnd(e));
                this.waypoints = this.map.points.map(p => ({ x: p.c * TILE + TILE / 2, y: p.r * TILE + TILE / 2 }));
                this.rngSeed = Date.now() % 2147483647;
            },

            random() {
                this.rngSeed = (this.rngSeed * 16807) % 2147483647;
                return (this.rngSeed - 1) / 2147483646;
            },

            start(diff) {
                this.difficulty = diff;
                this.beginGameLoop();
            },

            beginGameLoop() {
                const diff = this.difficulty;
                if (diff >= 0.20) this.lives = 1; else if (diff >= 0.15) this.lives = 3; else if (diff >= 0.10) this.lives = 10; else this.lives = 20;
                document.getElementById('global-overlay').classList.add('hidden');
                document.querySelectorAll('.sidebar').forEach(el => el.classList.remove('hidden'));
                document.getElementById('menu-content').style.display = 'block';

                this.playing = true; this.money = 250; this.wave = 1; CURRENT_ARSENAL = BASIC_TOWERS;
                this.enemies = []; this.towers = []; this.projectiles = []; this.particles = []; this.waveQueue = [];
                this.frames = 0;
                this.rngSeed = Date.now() % 2147483647;

                this.isAutoStarting = false; this.autoStartTimer = 0; this.updateAutoStartUI(); this.renderShop(); this.updateUI();
            },

            reset() { document.getElementById('game-over-screen').classList.add('hidden'); document.getElementById('global-overlay').classList.remove('hidden'); document.querySelectorAll('.sidebar').forEach(el => el.classList.add('hidden')); this.playing = false; this.towers = []; document.getElementById('save-msg').innerText = ""; this.isAutoStarting = false; this.autoStartTimer = 0; this.updateAutoStartUI(); document.getElementById('validation-loader').style.display = 'none'; document.getElementById('btn-restart').style.display = 'block'; },

            loop() { requestAnimationFrame(() => this.loop()); if (!this.playing) return; for (let i = 0; i < this.speed; i++) { this.update(); this.frames++; } this.draw(); },

            update() {
                if (this.waveQueue.length > 0) {
                    this.spawnTimer--;
                    if (this.spawnTimer <= 0) {
                        const type = this.waveQueue.shift();
                        this.enemies.push(new Enemy(type));
                        this.spawnTimer = type === 'fast' ? 12 : 35;
                        if (type.includes('boss') || type === 'neon_god' || type === 'entity_zero' || type === 'galactic_devourer') this.spawnTimer = 60;
                        if (type === 'white_guard' || type === 'cyber_angel') this.spawnTimer = 30;
                    }
                }
                if (this.waveQueue.length === 0 && this.enemies.length === 0 && this.playing) {
                    const btn = document.getElementById('start-btn');
                    if (btn.disabled && !this.isAutoStarting) { this.startAutoWaveTimer(); }
                }
                if (this.isAutoStarting) { this.autoStartTimer -= 1; this.updateAutoStartUI(); if (this.autoStartTimer <= 0) { this.nextWave(); } }
                let lasersFiring = 0;

                this.towers.forEach(t => {
                    t.update();
                    const isContinuousBeam = t.key === 'laser' || (t.key === 'omega' && t.isUlt);
                    if (isContinuousBeam && t.isFiring) lasersFiring++;
                });

                AudioEngine.setLaserVolume(lasersFiring);
                this.enemies.forEach(e => e.update()); this.projectiles.forEach(p => p.update()); this.particles.forEach(p => { p.x += p.vx || 0; p.y += p.vy || 0; p.life -= p.decay; });
                this.enemies = this.enemies.filter(e => !e.dead); this.projectiles = this.projectiles.filter(p => !p.dead); this.particles = this.particles.filter(p => p.life > 0);
                document.getElementById('enemies-display').innerText = this.enemies.length + this.waveQueue.length;
                if (this.shake > 0) { this.shake *= 0.9; if (this.shake < 0.5) this.shake = 0; }
            },

            draw() {
                const ctx = this.ctx; ctx.fillStyle = '#0a0a10'; ctx.fillRect(0, 0, 600, 720);
                if (this.shake > 0) { ctx.save(); ctx.translate((Math.random() - 0.5) * this.shake, (Math.random() - 0.5) * this.shake); }
                ctx.strokeStyle = '#151520'; ctx.lineWidth = 1; ctx.beginPath(); for (let x = 0; x <= 600; x += TILE) { ctx.moveTo(x, 0); ctx.lineTo(x, 720); } for (let y = 0; y <= 720; y += TILE) { ctx.moveTo(0, y); ctx.lineTo(600, y); } ctx.stroke();
                const grid = this.map.grid; ctx.shadowBlur = 15; ctx.shadowColor = 'rgba(0, 255, 204, 0.1)';
                for (let r = 0; r < grid.length; r++) { for (let c = 0; c < grid[0].length; c++) { if (grid[r][c] === 1) { ctx.fillStyle = '#16161d'; ctx.fillRect(c * TILE, r * TILE, TILE, TILE); ctx.strokeStyle = '#2a2a40'; ctx.lineWidth = 1; ctx.strokeRect(c * TILE, r * TILE, TILE, TILE); } } } ctx.shadowBlur = 0;
                ctx.strokeStyle = '#00ffcc'; ctx.lineWidth = 2; ctx.globalAlpha = 0.3;
                for (let r = 0; r < grid.length; r++) { for (let c = 0; c < grid[0].length; c++) { if (grid[r][c] === 1) { if (r > 0 && grid[r - 1][c] !== 1) { ctx.beginPath(); ctx.moveTo(c * TILE, r * TILE); ctx.lineTo((c + 1) * TILE, r * TILE); ctx.stroke(); } if (r < ROWS - 1 && grid[r + 1][c] !== 1) { ctx.beginPath(); ctx.moveTo(c * TILE, (r + 1) * TILE); ctx.lineTo((c + 1) * TILE, (r + 1) * TILE); ctx.stroke(); } if (c > 0 && grid[r][c - 1] !== 1) { ctx.beginPath(); ctx.moveTo(c * TILE, r * TILE); ctx.lineTo(c * TILE, (r + 1) * TILE); ctx.stroke(); } if (c < COLS - 1 && grid[r][c + 1] !== 1) { ctx.beginPath(); ctx.moveTo((c + 1) * TILE, r * TILE); ctx.lineTo((c + 1) * TILE, (r + 1) * TILE); ctx.stroke(); } } } } ctx.globalAlpha = 1;
                if (this.selectedTower) { ctx.beginPath(); ctx.arc(this.selectedTower.x, this.selectedTower.y, this.selectedTower.range, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; ctx.fill(); ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]); }
                ctx.fillStyle = '#00ffcc'; ctx.font = '10px Rajdhani'; ctx.fillText('INICIO', 10, 65); ctx.fillStyle = '#ff2a6d'; ctx.fillText('BASE', 560, 545);
                this.enemies.forEach(e => e.draw(ctx)); this.towers.forEach(t => t.draw(ctx)); this.projectiles.forEach(p => p.draw(ctx));
                this.particles.forEach(p => { ctx.globalAlpha = p.life; if (p.type === 'text') { ctx.fillStyle = p.color || 'white'; ctx.font = 'bold 16px Rajdhani'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.strokeText(p.text, p.x, p.y); ctx.fillText(p.text, p.x, p.y); } else if (p.type === 'bolt') { ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.tx, p.ty); ctx.stroke(); ctx.shadowBlur = 10; ctx.shadowColor = p.color; ctx.stroke(); ctx.shadowBlur = 0; } else if (p.type === 'ring') { ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(p.x, p.y, p.size * (1.5 - p.life), 0, Math.PI * 2); ctx.stroke(); } else if (p.type === 'muzzle') { ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 6 * p.life, 0, Math.PI * 2); ctx.fill(); } else { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 3, 3); } ctx.globalAlpha = 1; });
                if (this.shake > 0) ctx.restore();
            },

            damageEnemy(e, amount) { e.hit(amount); },
            killEnemy(e) { e.dead = true; this.money += e.money; this.addJuice('particle', e.x, e.y, 8, e.color); this.updateUI(); },

            async leakEnemy(e) {
                e.dead = true; this.lives--; this.shake = 15; this.updateUI();
                document.getElementById('game-wrapper').style.borderColor = '#ff2a6d';
                setTimeout(() => document.getElementById('game-wrapper').style.borderColor = '#2a2a40', 200);

                if (this.lives <= 0 && this.playing) {
                    this.playing = false;
                    const finalWave = this.wave - 1;

                    document.getElementById('game-over-screen').classList.remove('hidden');
                    document.getElementById('score-text').innerText = "OLEADAS RESISTIDAS: " + finalWave;
                    document.getElementById('validation-loader').style.display = 'none';
                    document.getElementById('btn-restart').style.display = 'block';

                    if (window.AuthManager.user) {
                        const dummyVerifiedData = { verified: true };
                        window.ScoreManager.saveScore(finalWave, this.difficulty, dummyVerifiedData);
                    } else {
                        document.getElementById('save-msg').innerText = "INICIA SESI√ìN PARA GUARDAR TU PUNTUACI√ìN";
                        document.getElementById('save-msg').style.color = "yellow";
                    }
                }
            },

            startAutoWaveTimer() { this.isAutoStarting = true; this.autoStartTimer = this.autoStartMax; document.getElementById('start-btn').disabled = false; document.getElementById('wave-info').innerText = "Siguiente oleada en..."; document.getElementById('auto-start-container').style.display = 'block'; this.updateAutoStartUI(); },
            updateAutoStartUI() { const bar = document.getElementById('auto-start-bar'); const btn = document.getElementById('start-btn'); if (this.isAutoStarting) { const pct = (this.autoStartTimer / this.autoStartMax) * 100; bar.style.width = pct + '%'; const seconds = Math.ceil(this.autoStartTimer / 60); btn.innerText = `PAUSAR (${seconds}s)`; btn.style.borderColor = '#ff2a6d'; btn.style.color = '#ff2a6d'; } else { document.getElementById('auto-start-container').style.display = 'none'; if (this.waveQueue.length === 0 && this.enemies.length === 0) { btn.innerText = "INICIAR OLEADA"; btn.style.borderColor = '#0288d1'; btn.style.color = '#81d4fa'; } } },
            clickStartBtn() { if (this.isAutoStarting) { this.isAutoStarting = false; this.autoStartTimer = 0; document.getElementById('wave-info').innerText = "Inicio Pausado"; this.updateAutoStartUI(); } else { this.nextWave(); } },

            nextWave() {
                this.isAutoStarting = false; this.autoStartTimer = 0; this.updateAutoStartUI();
                document.getElementById('start-btn').disabled = true; document.getElementById('start-btn').innerText = "COMBATIENDO..."; document.getElementById('start-btn').style.borderColor = '#0288d1'; document.getElementById('start-btn').style.color = '#81d4fa';
                this.wave++;
                this.waveQueue = [];
                document.getElementById('wave-info').innerText = `Oleada ${this.wave} entrante...`;

                if (this.wave < 10) {
                    const count = 6 + this.wave;
                    for (let i = 0; i < count; i++) this.waveQueue.push('basic');
                } else if (this.wave < 30) {
                    const count = 10 + Math.floor(this.wave * 1.5);
                    for (let i = 0; i < count; i++) {
                        let r = Game.random();
                        if (r < 0.4) this.waveQueue.push('basic');
                        else if (r < 0.7) this.waveQueue.push('fast');
                        else this.waveQueue.push('tank');
                    }
                    if (this.wave % 5 === 0) this.waveQueue.push('boss');
                } else if (this.wave < 50) {
                    const count = 30 + (this.wave - 30);
                    for (let i = 0; i < count; i++) {
                        let r = Game.random();
                        if (r < 0.3) this.waveQueue.push('fast');
                        else if (r < 0.8) this.waveQueue.push('tank');
                        else this.waveQueue.push('special');
                    }
                    if (this.wave % 5 === 0) {
                        const bossCount = 1 + Math.floor((this.wave - 30) / 5);
                        const bosses = ['boss', 'mecha_hydra', 'cyber_angel'];
                        for (let i = 0; i < bossCount; i++) {
                            const rndBoss = bosses[Math.floor(Game.random() * bosses.length)];
                            this.waveQueue.push(rndBoss);
                        }
                    }
                } else {

                    const whiteSwarmCount = 15 + Math.floor((this.wave - 50) / 2);
                    for (let i = 0; i < whiteSwarmCount; i++) {
                        const r = Game.random();
                        if (r < 0.4) this.waveQueue.push('white_guard');
                        else if (r < 0.7) this.waveQueue.push('special');
                        else this.waveQueue.push('tank');
                    }

                    if (this.wave > 100) {
                        const godTierBosses = ['entity_zero', 'neon_god', 'chaos_lord'];
                        const count = 1 + Math.floor((this.wave - 100) / 4);

                        for (let i = 0; i < count; i++) {
                            const boss = godTierBosses[Math.floor(Game.random() * godTierBosses.length)];
                            this.waveQueue.push(boss);
                        }

                    } else if (this.wave > 80) {
                        const chaosBosses = ['void_boss', 'chaos_lord', 'galactic_devourer'];
                        const voidCount = 2 + Math.floor((this.wave - 80) / 3);

                        for (let i = 0; i < voidCount; i++) {
                            const boss = chaosBosses[Math.floor(Game.random() * chaosBosses.length)];
                            this.waveQueue.push(boss);
                        }

                    } else {
                        const eliteBosses = ['white_boss', 'mecha_hydra', 'cyber_angel', 'galactic_devourer'];
                        const whiteCount = 1 + Math.floor((this.wave - 50) / 2);

                        for (let i = 0; i < whiteCount; i++) {
                            const boss = eliteBosses[Math.floor(Game.random() * eliteBosses.length)];
                            this.waveQueue.push(boss);
                        }
                    }
                }

                this.updateUI();
            },
            addJuice(type, x, y, extra1, extra2) { if (type === 'particle') for (let i = 0; i < extra1; i++) this.particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 4, vy: (Math.random() - 0.5) * 4, life: 1.0, decay: 0.04, color: extra2 }); else if (type === 'explosion') this.particles.push({ x: x, y: y, size: extra1, life: 1.0, decay: 0.08, color: extra2, type: 'ring' }); else if (type === 'text') this.particles.push({ x: x, y: y, vx: 0, vy: -1, life: 1.0, decay: 0.02, text: extra1, color: extra2, type: 'text' }); else if (type === 'bolt') this.particles.push({ x: x, y: y, tx: extra1, ty: extra2, life: 0.2, decay: 0.1, color: '#fff', type: 'bolt' }); else if (type === 'ring') this.particles.push({ x: x, y: y, size: extra1, life: 0.5, decay: 0.02, color: extra2, type: 'ring' }); else if (type === 'muzzle') this.particles.push({ x: x, y: y, life: 1.0, decay: 0.2, color: extra2, type: 'muzzle' }); },
            upgradeTower() {
                if (!this.selectedTower) return;
                const data = CURRENT_ARSENAL[this.selectedTower.key], nextUpg = data.upgrades[this.selectedTower.level - 1];
                if (nextUpg && this.money >= nextUpg.cost) {
                    this.money -= nextUpg.cost;
                    this.selectedTower.upgrade();
                    this.updateUpgradePanel();
                    this.updateUI();
                    AudioEngine.play('shoot');
                }
            },
            sellTower() { if (!this.selectedTower) return; const refund = Math.floor(this.selectedTower.spent * 0.7); this.money += refund; this.towers = this.towers.filter(t => t !== this.selectedTower); this.selectedTower = null; document.getElementById('upgrade-panel').style.display = 'none'; this.updateUI(); Game.addJuice('particle', 0, 0, 0, null); Game.recalcBlasterNerf(); },
            recalcBlasterNerf() { const blasters = this.towers.filter(t => t.key === 'cannon'); const count = blasters.length; blasters.forEach(t => { if (count > 5) { const penalty = (count - 5) * 0.1; t.efficiency = Math.max(0.2, 1.0 - penalty); } else { t.efficiency = 1.0; } }); },
            draggingType: null,
            startDrag(type) { if (this.money >= CURRENT_ARSENAL[type].cost) { this.draggingType = type; const ghost = document.getElementById('drag-ghost'); ghost.style.display = 'block'; ghost.style.borderColor = CURRENT_ARSENAL[type].color; ghost.style.boxShadow = `0 0 15px ${CURRENT_ARSENAL[type].color}`; } },
            handleMove(e) { const rect = this.canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top; if (this.draggingType) { const ghost = document.getElementById('drag-ghost'); ghost.style.left = e.clientX + 'px'; ghost.style.top = e.clientY + 'px'; } },
            handleDragEnd(e) {
                if (!this.draggingType) return;
                const rect = this.canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
                if (x >= 0 && x <= 600 && y >= 0 && y <= 720) {
                    const c = Math.floor(x / TILE), r = Math.floor(y / TILE);
                    const grid = this.map.grid;
                    if (grid[r] && grid[r][c] === 0 && !this.towers.some(t => t.c === c && t.r === r)) {
                        const cost = CURRENT_ARSENAL[this.draggingType].cost;
                        if (this.money >= cost) {
                            this.money -= cost;
                            this.towers.push(new Tower(c, r, this.draggingType));
                            this.updateUI();
                            AudioEngine.play('hit');
                            Game.addJuice('ring', c * TILE + TILE / 2, r * TILE + TILE / 2, TILE, '#fff');
                            Game.recalcBlasterNerf();
                        }
                    }
                }
                this.draggingType = null;
                document.getElementById('drag-ghost').style.display = 'none';
            },
            handleClick(e) { if (this.draggingType) return; const rect = this.canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top; const c = Math.floor(x / TILE), r = Math.floor(y / TILE); const clickedTower = this.towers.find(t => t.c === c && t.r === r); if (clickedTower) { this.selectedTower = clickedTower; this.updateUpgradePanel(); } else { this.selectedTower = null; document.getElementById('upgrade-panel').style.display = 'none'; } },
            updateUpgradePanel() { const t = this.selectedTower; if (!t) return; const panel = document.getElementById('upgrade-panel'); const data = CURRENT_ARSENAL[t.key], nextUpg = data.upgrades[t.level - 1]; panel.style.display = 'flex'; document.getElementById('upg-level').innerText = "NIVEL " + t.level; document.getElementById('upg-name').innerText = t.name; document.getElementById('upg-desc').innerHTML = `<div style="display:flex; justify-content:space-between"><span>Da√±o:</span> <span style="color:#fff">${(t.dmg * (t.efficiency || 1)).toFixed(0)}</span></div><div style="display:flex; justify-content:space-between"><span>Velocidad:</span> <span style="color:#fff">${(60 / t.rate).toFixed(1)}/s</span></div><div style="display:flex; justify-content:space-between"><span>Rango:</span> <span style="color:#fff">${(t.range / TILE).toFixed(1)}</span></div>`; const btn = document.getElementById('btn-upgrade'); if (nextUpg) { btn.innerHTML = `${t.level === 4 ? '‚òÖ MAXIMIZAR' : 'MEJORAR'}<br><span style="font-size:0.7em; opacity:0.8">${nextUpg.text}</span><br><span style="color:var(--gold)">$${nextUpg.cost}</span>`; btn.disabled = this.money < nextUpg.cost; btn.className = t.level === 4 ? "btn btn-ult" : "btn btn-upg"; } else { btn.innerHTML = "NIVEL M√ÅXIMO"; btn.disabled = true; btn.className = "btn"; } document.getElementById('btn-sell').innerHTML = `VENDER ($${Math.floor(t.spent * 0.7)})`; },
            renderShop() {
                const container = document.getElementById('shop-container');
                container.innerHTML = '';
                Object.keys(CURRENT_ARSENAL).forEach(key => {
                    const t = CURRENT_ARSENAL[key];
                    const div = document.createElement('div');
                    div.className = 'shop-item';

                    const canvas = document.createElement('canvas');
                    canvas.width = 40;
                    canvas.height = 40;
                    canvas.className = 'shop-icon-canvas';

                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 40, 40);
                    ctx.fillStyle = '#111';
                    ctx.fillRect(0, 0, 40, 40);

                    const dummy = new Tower(0, 0, key);
                    dummy.dummy = true;
                    dummy.angle = -Math.PI / 2;

                    dummy.draw(ctx);

                    div.appendChild(canvas);

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'shop-info';
                    infoDiv.innerHTML = `<span class="shop-name">${t.name}</span><span class="shop-cost">${t.cost}</span>`;
                    div.appendChild(infoDiv);
                    div.onmousedown = () => this.startDrag(key);
                    container.appendChild(div);
                });
            },
            updateUI() { document.getElementById('lives-display').innerText = this.lives; document.getElementById('money-display').innerText = this.money; document.getElementById('wave-display').innerText = this.wave; if (this.selectedTower) this.updateUpgradePanel(); },
            toggleSpeed() { if (this.speed === 1) this.speed = 2; else if (this.speed === 2) this.speed = 4; else this.speed = 1; document.getElementById('speed-btn').innerText = "VELOCIDAD: x" + this.speed; document.getElementById('speed-btn').style.background = this.speed === 4 ? "#d500f9" : (this.speed === 2 ? "#00695c" : "#222"); },

            openModal(id, mode = 'login') {
                const modal = document.getElementById(id);
                const header = document.getElementById('auth-modal-header');
                const submitBtn = document.getElementById('btn-auth-submit');
                const errorMsg = document.getElementById('auth-error-msg');

                if (id === 'auth-modal') {
                    this.authMode = mode;
                    errorMsg.innerText = "";
                    document.getElementById('auth-user').value = '';
                    document.getElementById('auth-pass').value = '';

                    if (mode === 'login') {
                        header.innerText = "ACCESO JUGADOR";
                        submitBtn.innerText = "ENTRAR";
                        submitBtn.onclick = () => Game.submitAuth('login');
                        submitBtn.className = "btn btn-start";
                    } else {
                        header.innerText = "REGISTRO NUEVO JUGADOR";
                        submitBtn.innerText = "CREAR CUENTA";
                        submitBtn.onclick = () => Game.submitAuth('register');
                        submitBtn.className = "btn btn-start";
                    }
                }
                modal.style.display = 'flex';
            },
            closeModal(id) {
                document.getElementById(id).style.display = 'none';
                if (id === 'auth-modal') {
                    document.getElementById('auth-error-msg').innerText = "";
                }
            },

            showAuthError(message) {
                document.getElementById('auth-error-msg').innerText = message;
            },

            submitAuth(mode) {
                const u = document.getElementById('auth-user').value;
                const p = document.getElementById('auth-pass').value;
                document.getElementById('auth-error-msg').innerText = "";

                if (!u || !p) return Game.showAuthError("Rellena ambos campos");

                if (mode === 'login') {
                    window.AuthManager.login(u, p);
                } else {
                    window.AuthManager.register(u, p);
                }
            },

            openLeaderboard() { this.openModal('lb-modal'); this.loadLeaderboard(0.10); },
            async loadLeaderboard(diff) { document.getElementById('lb-content').innerText = "Cargando..."; const data = await window.ScoreManager.getScores(diff); let html = '<table class="lb-table"><tr><th>RANGO</th><th>JUGADOR</th><th>OLEADAS</th></tr>'; if (data.length === 0) html += '<tr><td colspan="3" style="text-align:center; padding:20px; color:#666">No hay puntuaciones a√∫n.</td></tr>'; data.forEach((s, i) => { html += `<tr><td class="lb-rank">#${i + 1}</td><td>${s.username}</td><td class="lb-wave">${s.wave}</td></tr>`; }); html += '</table>'; document.getElementById('lb-content').innerHTML = html; },

            async checkCustomMod() {
                const params = new URLSearchParams(window.location.search);
                const modId = params.get('custom');
                if (modId) {
                    console.log("Loading custom mod:", modId);
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'mods', modId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const modData = docSnap.data();
                            console.log("Mod loaded:", modData);
                            // Add custom tower to BASIC_TOWERS
                            BASIC_TOWERS['custom_' + modId] = {
                                name: modData.name,
                                symbol: "‚òÖ",
                                type: "custom_" + modId,
                                color: modData.color,
                                cost: parseInt(modData.cost),
                                dmg: parseInt(modData.dmg),
                                range: parseInt(modData.range) * TILE,
                                rate: parseInt(modData.rate),
                                radius: 12,
                                desc: "Custom Tower",
                                upgrades: [
                                    { cost: parseInt(modData.cost), text: "+Verified", apply: t => t.dmg *= 1.5 }
                                ]
                            };
                            // Also define how to draw it in Tower.draw if needed, or use default fallback
                        } else {
                            console.error("Mod not found!");
                        }
                    } catch (e) {
                        console.error("Error fetching mod:", e);
                    }
                }
            }
        };

        window.onload = () => Game.init();
    </script>
</body>

</html>